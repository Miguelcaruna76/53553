name: Google Remote Desktop RDP

on:
  workflow_dispatch:
    inputs:
      pin:
        description: 'Enter the 6-digit PIN for Chrome Remote Desktop'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Chrome Remote Desktop
      run: |
        sudo apt-get update
        wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
        sudo dpkg --install chrome-remote-desktop_current_amd64.deb
        sudo apt install --assume-yes --fix-broken
        sudo DEBIAN_FRONTEND=noninteractive apt install --assume-yes xfce4 desktop-base
        sudo bash -c 'echo "exec /etc/X11/Xsession /usr/bin/xfce4-session" > /etc/chrome-remote-desktop-session'
        sudo usermod -a -G chrome-remote-desktop $USER
        sudo systemctl disable lightdm.service

    - name: Authenticate with Google Remote Desktop
      run: |
        printf "${{ github.event.inputs.pin }}\n${{ github.event.inputs.pin }}\nn\n" | sudo bash /opt/google/chrome-remote-desktop/chrome-remote-desktop --setup

    - name: Start Remote Desktop Service
      run: sudo systemctl start chrome-remote-desktop.service

    - name: Wait for Remote Desktop Service to start
      run: sleep 10

    - name: Install xrdp
      run: sudo apt-get install -y xrdp

    - name: Restart xrdp service
      run: sudo systemctl restart xrdp

    - name: Print IP Address
      run: hostname -I

    - name: Set up ngrok
      uses: w9jds/ngrok-action@v2
      with:
        authtoken: ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Keep RDP session running
      run: tmux new -d -s RDP 'sudo systemctl restart chrome-remote-desktop.service && sleep 1d'
